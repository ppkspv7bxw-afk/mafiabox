<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Display — GameHub4u</title>
  <link rel="stylesheet" href="/common.css"/>
</head>
<body>
  <div class="wrap wrap--wide">
    <div class="card">
      <div class="brand"><img src="/brand.png" alt="brand"></div>

      <div class="row">
        <div class="pill">Room: <span id="roomCode" class="roomCode">----</span></div>
        <div class="pill">Game: <strong id="game">&mdash;</strong></div>
        <div class="pill">Phase: <strong id="phase">&mdash;</strong></div>
        <div class="pill">Round: <strong id="round">&mdash;</strong></div>
      </div>

      <div class="grid">
        <div class="box">
          <div class="title">Players</div>
          <div id="players"></div>
          <div class="small" style="margin-top:8px;">(Display mode shows no roles)</div>
        </div>

        <div class="box">
          <div class="title">Last Result</div>
          <div id="result" class="small">&mdash;</div>
          <div id="winner" style="margin-top:10px;font-weight:1000;"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <script src="https://jackbox-server-pwtr.onrender.com/socket.io/socket.io.js"></script>
  <script src="/common.js"></script>
  <script>
    const roomCode = (getParam("room") || "").trim().toUpperCase();

    const roomCodeEl = document.getElementById("roomCode");
    const playersEl  = document.getElementById("players");
    const gameEl     = document.getElementById("game");
    const phaseEl    = document.getElementById("phase");
    const roundEl    = document.getElementById("round");
    const resultEl   = document.getElementById("result");
    const winnerEl   = document.getElementById("winner");

    roomCodeEl.textContent = roomCode || "----";

    const displayId = "display-" + Math.random().toString(16).slice(2);
    const socket = createSocket(displayId);

    let lastPhaseVal = null;

    function renderPlayers(list){
      playersEl.innerHTML = "";
      (list || []).forEach(p => {
        const div = document.createElement("div");
        div.className = "player";
        div.innerHTML = `
          <div style="font-weight:950; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${escapeHtml(p.name||"Player")}</div>
          <div class="badge ${p.ready ? "ready" : ""}">${p.ready ? "READY" : "WAIT"}</div>
        `;
        playersEl.appendChild(div);
      });
      if (!list || list.length === 0){
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "No players yet";
        playersEl.appendChild(div);
      }
    }

    socket.on("connect", () => {
      if (!roomCode) return;
      socket.emit("room:getState", { roomCode });
      socket.emit("hub:getState", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId: displayId });
    });

    socket.on("room:state", ({ players } = {}) => renderPlayers(players || []));
    socket.on("hub:state", ({ currentGame } = {}) => gameEl.textContent = currentGame || "\u2014");

    socket.on("mafia:state", (s) => {
      if (!s) return;

      /* Phase animation */
      if (lastPhaseVal !== s.phase && s.phase) {
        phaseEl.classList.remove("phase-enter");
        void phaseEl.offsetWidth;
        phaseEl.classList.add("phase-enter");
      }
      lastPhaseVal = s.phase;
      phaseEl.textContent = labelPhase(s.phase);
      roundEl.textContent = s.round || "\u2014";

      if (s.lastResult){
        if (s.lastResult.type === "night"){
          const died = s.lastResult.died ? s.lastResult.died.name : "No one";
          resultEl.textContent = "Night: " + died + " died.";
        } else if (s.lastResult.type === "day"){
          if (s.lastResult.tie) resultEl.textContent = "Day: Tie \u2014 no one eliminated.";
          else {
            const el = s.lastResult.eliminated ? s.lastResult.eliminated.name : "No one";
            resultEl.textContent = "Day: " + el + " eliminated.";
          }
        }
      } else {
        resultEl.textContent = "\u2014";
      }

      winnerEl.textContent = s.winnerTeam ? (s.winnerTeam === "mafia" ? "MAFIA WINS" : "TOWN WINS") : "";
    });

    socket.on("mafia:tick", () => {
      socket.emit("mafia:getState", { roomCode, clientId: displayId });
    });

    /* Fallback polling — 5s instead of 1.2s */
    setInterval(() => {
      if (!roomCode || !socket.connected) return;
      socket.emit("room:getState", { roomCode });
      socket.emit("hub:getState", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId: displayId });
    }, 5000);
  </script>
</body>
</html>
