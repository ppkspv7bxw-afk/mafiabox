<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Host â€” GameHub4u</title>
  <link rel="stylesheet" href="/common.css"/>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span id="light" class="statusLight"></span>
      <div class="brand"><img src="/brand.png" alt="brand"></div>

      <div class="row">
        <div class="pill">Room: <span id="roomCode" class="roomCode">----</span></div>
        <div class="pill">Status: <strong id="statusTxt">Connecting&hellip;</strong></div>
      </div>

      <div class="box">
        <div style="font-weight:1000;">Join Link</div>
        <div class="small" id="linkText" style="margin-top:6px;">&mdash;</div>

        <div class="copyRow">
          <button id="copyBtn" class="copyBtn" type="button" aria-label="Copy link">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M9 9h10v10H9V9Z" stroke="white" stroke-width="2"/>
              <path d="M5 15H4a1 1 0 0 1-1-1V4a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v1" stroke="white" stroke-width="2"/>
            </svg>
          </button>
          <div class="pill" style="flex:1;min-width:240px;justify-content:space-between;">
            <span>Code:</span><span id="codeInline" class="roomCode">----</span>
          </div>
        </div>

        <div class="qrWrap">
          <div>
            <div class="small">Scan QR</div>
            <div class="qr"><img id="qrImg" alt="QR"></div>
            <div class="small" style="margin-top:6px;">(White background for best scanning)</div>
          </div>

          <div style="flex:1;min-width:300px;">
            <div style="font-weight:1000;">Host Mode</div>

            <div style="margin-top:10px;">
              <div class="label">Mode</div>
              <select id="mode" class="select">
                <option value="hostPlayer" selected>Host & Player</option>
                <option value="display">Display</option>
              </select>
            </div>

            <div id="nameBox" style="margin-top:10px;">
              <div class="label">Your name (Host as player)</div>
              <input id="hostName" class="input" placeholder="e.g. Mohammed" maxlength="20" autocomplete="off"/>
              <div class="small" style="margin-top:6px;">This will add you to the lobby players list.</div>
            </div>

            <div class="btnRow" style="justify-content:flex-start;">
              <button id="primaryBtn" class="btn" type="button" disabled>Join & Go Lobby</button>
              <button id="recreate" class="btn secondary" type="button" disabled>Recreate Room</button>
            </div>

            <div class="small" style="margin-top:10px;">
              Display mode opens a TV screen (no roles). Host still controls from Lobby.
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <script src="https://jackbox-server-pwtr.onrender.com/socket.io/socket.io.js"></script>
  <script src="/common.js"></script>
  <script>
    const light      = document.getElementById("light");
    const statusTxt  = document.getElementById("statusTxt");
    const roomCodeEl = document.getElementById("roomCode");
    const codeInline = document.getElementById("codeInline");
    const linkText   = document.getElementById("linkText");
    const qrImg      = document.getElementById("qrImg");
    const copyBtn    = document.getElementById("copyBtn");
    const modeSel    = document.getElementById("mode");
    const nameBox    = document.getElementById("nameBox");
    const hostName   = document.getElementById("hostName");
    const primaryBtn = document.getElementById("primaryBtn");
    const recreate   = document.getElementById("recreate");

    const socket = createSocket();

    let roomCode = "";

    /* ---- Status ---- */
    socket.on("connect", () => {
      light.classList.add("ok");
      statusTxt.textContent = "Connected";
      socket.emit("host:createRoom");
    });

    socket.on("disconnect", () => {
      light.classList.remove("ok");
      statusTxt.textContent = "Disconnected";
      primaryBtn.disabled = true;
      recreate.disabled = true;
    });

    setupReconnectOverlay(socket);

    /* ---- Room ---- */
    function setRoom(code){
      roomCode = (code || "").trim().toUpperCase();
      roomCodeEl.textContent = roomCode || "----";
      codeInline.textContent = roomCode || "----";

      const link = WEB_ORIGIN + "/?room=" + encodeURIComponent(roomCode);
      linkText.textContent = link;
      qrImg.src = SERVER_URL + "/qr?data=" + encodeURIComponent(link);

      primaryBtn.disabled = !roomCode;
      recreate.disabled = !roomCode;
    }

    socket.on("room:created", ({ roomCode: rc } = {}) => {
      setRoom(rc);
      showToast("Room ready");
    });

    /* ---- Mode toggle ---- */
    function refreshModeUI(){
      const mode = modeSel.value;
      nameBox.style.display = (mode === "hostPlayer") ? "block" : "none";
      primaryBtn.textContent = (mode === "display") ? "Open Display" : "Join & Go Lobby";
    }
    modeSel.onchange = refreshModeUI;
    refreshModeUI();

    /* ---- Actions ---- */
    copyBtn.onclick = async () => {
      if (!roomCode) return;
      const link = WEB_ORIGIN + "/?room=" + encodeURIComponent(roomCode);
      try {
        await navigator.clipboard.writeText(link);
        showToast("Link copied");
      } catch(e) {
        showToast("Copy failed");
      }
    };

    primaryBtn.onclick = () => {
      if (!roomCode) return;

      if (modeSel.value === "display") {
        location.href = WEB_ORIGIN + "/display.html?room=" + encodeURIComponent(roomCode);
        return;
      }

      const nm = validateName(hostName.value);
      if (!nm.ok) {
        hostName.classList.add("invalid");
        setTimeout(() => hostName.classList.remove("invalid"), 400);
        return showToast(nm.msg);
      }

      socket.emit("host:joinAsPlayer", { roomCode, name: nm.value });
    };

    socket.on("host:joinedAsPlayer", ({ roomCode: rc } = {}) => {
      const code = (rc || roomCode || "").trim().toUpperCase();
      showToast("Joined as player");
      setTimeout(() => {
        location.href = WEB_ORIGIN + "/lobby.html?room=" + encodeURIComponent(code);
      }, 200);
    });

    socket.on("host:joinAsPlayer:error", ({ message } = {}) => {
      showToast(message || "Join failed");
    });

    recreate.onclick = () => socket.emit("host:createRoom");
  </script>
</body>
</html>
