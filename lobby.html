<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lobby</title>
  <style>
    :root{
      --bg:#0b1020; --text:#eef1ff; --muted:#a7b0d6;
      --border:rgba(255,255,255,.10);
      --shadow:0 14px 40px rgba(0,0,0,.45);
      --red:#ff2e55; --green:#2ee59d;
      --btn1:#ff3b6a; --btn2:#ff1f4f;
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, #19214a 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .statusLight{
      position:absolute; top:14px; left:14px;
      width:14px; height:14px; border-radius:999px;
      background: var(--red);
      box-shadow: 0 0 0 4px rgba(255,46,85,.12), 0 0 18px rgba(255,46,85,.35);
    }
    .statusLight.ok{
      background: var(--green);
      box-shadow: 0 0 0 4px rgba(46,229,157,.14), 0 0 18px rgba(46,229,157,.35);
    }
    .brand{display:flex;justify-content:center;margin:6px 0 12px}
    .brand img{
      width:260px;max-width:90%;height:auto;
      filter: drop-shadow(0 18px 34px rgba(255,35,79,.18));
      border-radius:18px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.25);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      font-size:13px;color:var(--muted);
    }
    .roomCode{font-weight:950;letter-spacing:4px;color:#fff}
    .tabs{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .tab{
      padding:10px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-weight:950;
      cursor:pointer;
      opacity:.85;
    }
    .tab.active{opacity:1;border-color:rgba(255,59,106,.35);background:rgba(255,59,106,.10)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    .box{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:14px;
    }
    .title{font-weight:1000;margin-bottom:10px}
    .small{font-size:12px;color:var(--muted)}
    .player{
      padding:12px;border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      display:flex;justify-content:space-between;align-items:center;gap:10px;
      margin-bottom:8px;
    }
    .badge{
      font-weight:950;font-size:12px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(167,176,214,.95);
      white-space:nowrap;
    }
    .badge.ready{
      border-color: rgba(46,229,157,.25);
      color: rgba(46,229,157,.95);
      background: rgba(46,229,157,.10);
    }
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{
      border:0;border-radius:16px;padding:12px 14px;
      font-weight:950;cursor:pointer;color:#fff;
      background: linear-gradient(135deg, var(--btn1), var(--btn2));
      box-shadow: 0 12px 26px rgba(255,35,79,.22);
      display:inline-flex;align-items:center;justify-content:center;white-space:nowrap;
      transition: transform .08s ease, filter .15s ease, opacity .15s ease;
      position:relative;overflow:hidden;
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:scale(.99)}
    .btn:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
    .btn.secondary{
      background: rgba(255,255,255,.07);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;color:var(--text);
    }
    .btn.small{padding:10px 12px;border-radius:14px}
    .btn::after{
      content:"";position:absolute;top:-40%;left:-60%;
      width:40%;height:180%;transform:rotate(25deg);
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.22), transparent);
      animation: shine 2.2s infinite;
    }
    .btn.secondary::after{display:none}
    @keyframes shine{0%{left:-60%}55%{left:120%}100%{left:120%}}

    .select, .input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
      font-weight:900;
      font-size:14px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .row2{grid-template-columns:1fr} }

    .toast{
      position: fixed;left: 16px;bottom: 16px;
      background: rgba(0,0,0,.55);
      border: 1px solid rgba(255,255,255,.12);
      color: var(--text);
      padding: 10px 12px;border-radius: 14px;font-weight: 900;
      display:none;z-index: 9999;box-shadow: var(--shadow);
    }
    .devBadge{
      display:none;
      margin-left:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.08);
      font-weight:1000;
      color: rgba(255,210,218,.95);
    }
    .devBadge.on{display:inline-flex}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:12px 0}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span id="light" class="statusLight"></span>
      <div class="brand"><img src="/brand.png" alt="brand"></div>

      <div class="row">
        <div class="pill">
          Room: <span id="roomCode" class="roomCode">----</span>
          <span id="devBadge" class="devBadge">DEV</span>
        </div>
        <div class="pill">Players: <strong id="pCount">0</strong></div>
        <div class="pill">You: <strong id="meName">—</strong></div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="players">Players</button>
        <button class="tab" data-tab="mafia">Mafia</button>
        <button class="tab" data-tab="score">Scoreboard</button>
      </div>

      <div class="grid">
        <!-- PLAYERS -->
        <div id="tab-players" class="box">
          <div class="title">Players</div>
          <div id="playersList"></div>

          <div class="btnRow">
            <button id="readyBtn" class="btn secondary" type="button">Ready</button>
            <button id="leaveBtn" class="btn secondary" type="button">Leave</button>
          </div>

          <div class="small" style="margin-top:10px;">
            Ready affects UI only (for now). Host can start Mafia anytime.
          </div>
        </div>

        <!-- MAFIA -->
        <div id="tab-mafia" class="box" style="display:none;">
          <div class="title">Mafia</div>

          <div class="row">
            <div class="pill">Phase: <strong id="phase">—</strong></div>
            <div class="pill">Round: <strong id="round">—</strong></div>
            <div class="pill">Winner: <strong id="winner">—</strong></div>
          </div>

          <div class="hr"></div>

          <div class="small">Your Role</div>
          <div class="pill" style="margin-top:8px;"><strong id="myRole">—</strong></div>

          <div id="investigationBox" class="small" style="margin-top:10px;display:none;"></div>

          <div class="hr"></div>

          <div class="title" style="margin-bottom:8px;">Actions</div>
          <div class="row2">
            <div>
              <div class="small">Target</div>
              <select id="targetSelect" class="select"></select>
            </div>
            <div>
              <div class="small">Action</div>
              <select id="actionSelect" class="select">
                <option value="kill">Kill (Mafia)</option>
                <option value="save">Save (Doctor)</option>
                <option value="check">Check (Detective)</option>
                <option value="vote">Vote (Day)</option>
              </select>
            </div>
          </div>

          <div class="btnRow">
            <button id="doActionBtn" class="btn" type="button">Submit</button>
          </div>

          <div class="hr"></div>

          <div id="hostControls" style="display:none;">
            <div class="title">Host Controls</div>
            <div class="btnRow">
              <button id="startMafiaBtn" class="btn" type="button">Start Mafia</button>
              <button id="nextBtn" class="btn secondary" type="button">Next Phase</button>
              <button id="forceNightBtn" class="btn secondary small" type="button">Force Resolve Night</button>
              <button id="forceDayBtn" class="btn secondary small" type="button">Force Resolve Day</button>
            </div>

            <div id="devPanel" style="display:none;margin-top:14px;">
              <div class="title">Dev Tools (Test)</div>
              <div class="small">
                Dev mode starts from <b>2 players</b> and allows role controls.
              </div>

              <div class="btnRow" style="margin-top:10px;">
                <button id="revealBtn" class="btn secondary" type="button">Reveal Roles</button>
              </div>

              <div class="row2" style="margin-top:10px;">
                <div>
                  <div class="small">Pick Player</div>
                  <select id="devPlayerSelect" class="select"></select>
                </div>
                <div>
                  <div class="small">Set Role</div>
                  <select id="devRoleSelect" class="select">
                    <option value="mafia">mafia</option>
                    <option value="detective">detective</option>
                    <option value="doctor">doctor</option>
                    <option value="villager">villager</option>
                  </select>
                </div>
              </div>

              <div class="btnRow">
                <button id="setRoleBtn" class="btn secondary" type="button">Apply Role</button>
                <button id="toggleAliveBtn" class="btn secondary" type="button">Toggle Alive/Dead</button>
              </div>

              <div id="revealBox" class="box" style="margin-top:10px;">
                <div class="small">Revealed Roles (Host only)</div>
                <div id="revealList" class="small mono" style="margin-top:8px;">—</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="title">Last Result</div>
          <div id="lastResult" class="small">—</div>
        </div>

        <!-- SCORE -->
        <div id="tab-score" class="box" style="display:none;">
          <div class="title">Scoreboard</div>
          <div id="scoreList"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <script src="https://jackbox-server-pwtr.onrender.com/socket.io/socket.io.js"></script>
  <script>
    const SERVER_URL = "https://jackbox-server-pwtr.onrender.com";

    const qs = new URLSearchParams(location.search);
    const roomCode = (qs.get("room") || "").trim().toUpperCase();
    const dev = qs.get("dev") === "1";

    function uuidFallback(){
      return "id-" + Date.now().toString(16) + "-" + Math.random().toString(16).slice(2);
    }
    const clientId = localStorage.getItem("clientId") || (crypto && crypto.randomUUID ? crypto.randomUUID() : uuidFallback());
    localStorage.setItem("clientId", clientId);

    const light = document.getElementById("light");
    const roomCodeEl = document.getElementById("roomCode");
    const devBadge = document.getElementById("devBadge");
    const pCount = document.getElementById("pCount");
    const meName = document.getElementById("meName");
    const toast = document.getElementById("toast");

    const playersList = document.getElementById("playersList");
    const readyBtn = document.getElementById("readyBtn");
    const leaveBtn = document.getElementById("leaveBtn");

    const phaseEl = document.getElementById("phase");
    const roundEl = document.getElementById("round");
    const winnerEl = document.getElementById("winner");
    const myRoleEl = document.getElementById("myRole");
    const lastResultEl = document.getElementById("lastResult");
    const investigationBox = document.getElementById("investigationBox");

    const targetSelect = document.getElementById("targetSelect");
    const actionSelect = document.getElementById("actionSelect");
    const doActionBtn = document.getElementById("doActionBtn");

    const hostControls = document.getElementById("hostControls");
    const startMafiaBtn = document.getElementById("startMafiaBtn");
    const nextBtn = document.getElementById("nextBtn");
    const forceNightBtn = document.getElementById("forceNightBtn");
    const forceDayBtn = document.getElementById("forceDayBtn");

    const devPanel = document.getElementById("devPanel");
    const revealBtn = document.getElementById("revealBtn");
    const revealList = document.getElementById("revealList");
    const devPlayerSelect = document.getElementById("devPlayerSelect");
    const devRoleSelect = document.getElementById("devRoleSelect");
    const setRoleBtn = document.getElementById("setRoleBtn");
    const toggleAliveBtn = document.getElementById("toggleAliveBtn");

    const scoreList = document.getElementById("scoreList");

    roomCodeEl.textContent = roomCode || "----";
    if (dev) devBadge.classList.add("on");

    function showToast(text){
      toast.textContent = text;
      toast.style.display = "block";
      clearTimeout(toast._t);
      toast._t = setTimeout(() => toast.style.display = "none", 1500);
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    let isHost = false;
    let myReady = false;
    let currentPlayers = [];
    let mafiaState = null;

    const socket = io(SERVER_URL, { transports:["websocket","polling"], auth:{ clientId } });

    socket.on("connect", () => {
      light.classList.add("ok");
      if (!roomCode) return;

      // Try attach as host; if fails, attach as player
      socket.emit("host:attach", { roomCode });

      // Always fetch latest
      socket.emit("room:getState", { roomCode });
      socket.emit("hub:getState", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId });

      // If dev=1 and you are host, enable dev mode on server
      // We'll do it after we know isHost from room:state
    });

    socket.on("disconnect", () => light.classList.remove("ok"));

    socket.on("host:attached", () => {
      // ok
    });

    socket.on("host:attach:error", () => {
      // Not host, attach as player (if exists)
      socket.emit("player:attach", { roomCode, clientId });
    });

    // Tabs
    document.querySelectorAll(".tab").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        const key = btn.dataset.tab;
        document.getElementById("tab-players").style.display = (key === "players") ? "block" : "none";
        document.getElementById("tab-mafia").style.display   = (key === "mafia")   ? "block" : "none";
        document.getElementById("tab-score").style.display   = (key === "score")   ? "block" : "none";
      };
    });

    function renderPlayers(players){
      playersList.innerHTML = "";
      currentPlayers = players || [];
      pCount.textContent = String(currentPlayers.length);

      const me = currentPlayers.find(p => p.clientId === clientId);
      meName.textContent = me ? me.name : "—";
      myReady = !!(me && me.ready);
      readyBtn.textContent = myReady ? "Unready" : "Ready";

      // Targets dropdown (alive only if mafia state exists)
      targetSelect.innerHTML = "";
      devPlayerSelect.innerHTML = "";

      const addOpt = (sel, p) => {
        const opt = document.createElement("option");
        opt.value = p.clientId;
        opt.textContent = p.name + (p.clientId === clientId ? " (you)" : "");
        sel.appendChild(opt);
      };

      currentPlayers.forEach(p => addOpt(devPlayerSelect, p));

      // For action targets: use mafiaState.alive if exists, otherwise all players
      const aliveMap = new Map();
      if (mafiaState && mafiaState.alive) {
        mafiaState.alive.forEach(a => aliveMap.set(a.clientId, !!a.alive));
      }
      const candidates = (mafiaState && mafiaState.alive) ? mafiaState.alive.filter(a => a.alive) : currentPlayers;

      candidates.forEach(p => addOpt(targetSelect, p));

      currentPlayers.forEach(p => {
        const div = document.createElement("div");
        div.className = "player";
        div.innerHTML = `
          <div style="font-weight:950; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${escapeHtml(p.name)}
          </div>
          <div class="badge ${p.ready ? "ready" : ""}">${p.ready ? "READY" : "WAIT"}</div>
        `;
        playersList.appendChild(div);
      });

      if (!currentPlayers.length) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "No players yet";
        playersList.appendChild(div);
      }
    }

    function labelPhase(p){
      if (p === "role") return "ROLE";
      if (p === "night") return "NIGHT";
      if (p === "day") return "DAY";
      return p || "—";
    }

    function renderLastResult(s){
      if (!s || !s.lastResult){ lastResultEl.textContent = "—"; return; }
      const r = s.lastResult;

      if (r.type === "night") {
        const died = r.died ? r.died.name : "No one";
        lastResultEl.textContent = `Night: ${died} died.`;
        return;
      }
      if (r.type === "day") {
        if (r.tie) lastResultEl.textContent = "Day: Tie — no one eliminated.";
        else {
          const el = r.eliminated ? r.eliminated.name : "No one";
          lastResultEl.textContent = `Day: ${el} eliminated.`;
        }
        return;
      }
      lastResultEl.textContent = "—";
    }

    function renderScoreboard(state){
      scoreList.innerHTML = "";
      const list = (state && state.leaderboard) ? state.leaderboard : [];
      if (!list.length) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "No scores yet";
        scoreList.appendChild(div);
        return;
      }
      list.forEach((x, idx) => {
        const div = document.createElement("div");
        div.className = "player";
        div.innerHTML = `
          <div>
            <div style="font-weight:1000;">#${idx+1} ${escapeHtml(x.name || "Player")}</div>
            <div class="small">wins: ${x.wins || 0} • played: ${x.gamesPlayed || 0}</div>
          </div>
          <div class="badge ready">${x.points || 0} pts</div>
        `;
        scoreList.appendChild(div);
      });
    }

    socket.on("room:state", (st) => {
      if (!st) return;

      isHost = (st.hostClientId && st.hostClientId === clientId);
      hostControls.style.display = isHost ? "block" : "none";

      // enable server dev mode if dev=1 and host
      if (dev && isHost) {
        devPanel.style.display = "block";
        socket.emit("host:setDevMode", { roomCode, enabled: true });
      } else {
        devPanel.style.display = "none";
      }

      renderPlayers(st.players || []);
    });

    socket.on("hub:state", (st) => {
      renderScoreboard(st);
      // if dev toggled server-side, keep badge visible
      if (st && st.devMode) devBadge.classList.add("on");
    });

    socket.on("start:error", ({ message, minPlayers } = {}) => {
      if (message === "NEED_MIN_PLAYERS") {
        showToast(`Need ${minPlayers} players`);
      } else {
        showToast(message || "Start error");
      }
    });

    socket.on("mafia:role", ({ role } = {}) => {
      myRoleEl.textContent = role ? String(role).toUpperCase() : "—";
    });

    socket.on("mafia:state", (s) => {
      if (!s) return;
      mafiaState = s;

      phaseEl.textContent = labelPhase(s.phase);
      roundEl.textContent = s.round || "—";
      winnerEl.textContent = s.winnerTeam ? s.winnerTeam.toUpperCase() : "—";
      myRoleEl.textContent = s.myRole ? String(s.myRole).toUpperCase() : (myRoleEl.textContent || "—");

      if (s.investigationResult) {
        investigationBox.style.display = "block";
        const tgt = s.investigationResult.targetId;
        const isMafia = !!s.investigationResult.isMafia;
        const tgtName = (currentPlayers.find(p => p.clientId === tgt)?.name) || "Player";
        investigationBox.textContent = `Detective: ${tgtName} is ${isMafia ? "MAFIA" : "NOT mafia"}.`;
      } else {
        investigationBox.style.display = "none";
      }

      // refresh targets based on alive list
      renderPlayers(currentPlayers);

      renderLastResult(s);
    });

    // DEV reveal list
    socket.on("mafia:reveal", ({ list } = {}) => {
      if (!list || !list.length) { revealList.textContent = "—"; return; }
      revealList.textContent = list.map(x => `${x.name} = ${x.role}${x.alive ? "" : " (dead)"}`).join("\n");
      showToast("Roles revealed");
    });

    // Buttons
    readyBtn.onclick = () => {
      if (!roomCode) return;
      myReady = !myReady;
      socket.emit("player:ready", { roomCode, ready: myReady, clientId });
    };

    leaveBtn.onclick = () => {
      if (!roomCode) return;
      socket.emit("player:leave", { roomCode, clientId });
      showToast("Left");
      setTimeout(() => location.href = "/", 300);
    };

    startMafiaBtn.onclick = () => socket.emit("mafia:start", { roomCode });
    nextBtn.onclick = () => socket.emit("mafia:next", { roomCode });
    forceNightBtn.onclick = () => socket.emit("mafia:forceResolveNight", { roomCode });
    forceDayBtn.onclick = () => socket.emit("mafia:forceResolveDay", { roomCode });

    doActionBtn.onclick = () => {
      const tgt = targetSelect.value;
      const act = actionSelect.value;

      if (!tgt) return showToast("Pick target");

      if (act === "vote") {
        socket.emit("mafia:vote", { roomCode, clientId, targetId: tgt });
        showToast("Voted");
        return;
      }

      socket.emit("mafia:nightAction", { roomCode, clientId, action: act, targetId: tgt });
      showToast("Sent");
    };

    // Dev tools
    revealBtn.onclick = () => socket.emit("mafia:revealAll", { roomCode });

    setRoleBtn.onclick = () => {
      const p = devPlayerSelect.value;
      const r = devRoleSelect.value;
      if (!p) return;
      socket.emit("mafia:setRole", { roomCode, targetId: p, role: r });
      showToast("Role applied");
    };

    toggleAliveBtn.onclick = () => {
      const p = devPlayerSelect.value;
      if (!p) return;
      socket.emit("mafia:toggleAlive", { roomCode, targetId: p });
      showToast("Toggled");
    };

    // keep fresh
    setInterval(() => {
      if (!roomCode) return;
      socket.emit("room:getState", { roomCode });
      socket.emit("hub:getState", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId });
    }, 1200);
  </script>
</body>
</html>