<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lobby â€” GameHub4u</title>
  <link rel="stylesheet" href="/common.css"/>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span id="light" class="statusLight"></span>
      <div class="brand"><img src="/brand.png" alt="brand"></div>

      <div class="row">
        <div class="pill">
          Room: <span id="roomCode" class="roomCode">----</span>
          <span id="devBadge" class="devBadge">DEV</span>
        </div>
        <div class="pill">Players: <strong id="pCount">0</strong></div>
        <div class="pill">You: <strong id="meName">&mdash;</strong></div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="players">Players</button>
        <button class="tab" data-tab="games">Games</button>
        <button class="tab" data-tab="mafia">Mafia</button>
        <button class="tab" data-tab="score">Scoreboard</button>
      </div>

      <div class="grid" style="grid-template-columns:1fr;">

        <!-- ===== PLAYERS TAB ===== -->
        <div id="tab-players" class="box">
          <div class="title">Players</div>
          <div id="playersList"></div>

          <div class="btnRow">
            <button id="readyBtn" class="btn secondary" type="button">Ready</button>
            <button id="leaveBtn" class="btn secondary" type="button">Leave</button>
          </div>

          <div class="small" style="margin-top:10px;">
            Ready affects UI only (for now). Host can start Mafia anytime.
          </div>
        </div>

        <!-- ===== GAMES TAB ===== -->
        <div id="tab-games" class="box" style="display:none;">
          <div class="title">Choose a Game</div>

          <div id="gameMafiaCard" class="gameCard selectable">
            <div class="gameLeft">
              <div class="gameTitle">Mafia</div>
              <div class="gameMeta">5&ndash;12 players &bull; Roles &bull; Voting &bull; Rounds</div>
            </div>
            <span class="badge ready">PLAY</span>
          </div>

          <div class="gameCard">
            <div class="gameLeft">
              <div class="gameTitle">Secret Hitler</div>
              <div class="gameMeta">5&ndash;10 players &bull; Deception &bull; Policies</div>
            </div>
            <span class="badge soon">SOON</span>
          </div>

          <div class="gameCard">
            <div class="gameLeft">
              <div class="gameTitle">Werewolf</div>
              <div class="gameMeta">6&ndash;16 players &bull; Roles &bull; Night/Day</div>
            </div>
            <span class="badge soon">SOON</span>
          </div>

          <div class="gameCard">
            <div class="gameLeft">
              <div class="gameTitle">Resident</div>
              <div class="gameMeta">4&ndash;8 players &bull; Strategy</div>
            </div>
            <span class="badge soon">SOON</span>
          </div>

          <div class="gameCard">
            <div class="gameLeft">
              <div class="gameTitle">Out of the Loop</div>
              <div class="gameMeta">3&ndash;10 players &bull; Word game &bull; Deduction</div>
            </div>
            <span class="badge soon">SOON</span>
          </div>

          <div class="small" style="margin-top:10px;">
            Host selects a game, then starts it when players are ready.
          </div>
        </div>

        <!-- ===== MAFIA TAB ===== -->
        <div id="tab-mafia" class="box" style="display:none;">
          <div class="title">Mafia</div>

          <div class="row">
            <div class="pill">Phase: <strong id="phase">&mdash;</strong></div>
            <div class="pill">Round: <strong id="round">&mdash;</strong></div>
            <div class="pill">Winner: <strong id="winner">&mdash;</strong></div>
          </div>

          <div class="hr"></div>

          <div class="small">Your Role</div>
          <div class="pill" style="margin-top:8px;"><strong id="myRole">&mdash;</strong></div>

          <div id="investigationBox" class="small" style="margin-top:10px;display:none;"></div>

          <div class="hr"></div>

          <div class="title" style="margin-bottom:8px;">Actions</div>
          <div class="row2">
            <div>
              <div class="small">Target</div>
              <select id="targetSelect" class="select"></select>
            </div>
            <div>
              <div class="small">Action</div>
              <select id="actionSelect" class="select">
                <option value="kill">Kill (Mafia)</option>
                <option value="save">Save (Doctor)</option>
                <option value="check">Check (Detective)</option>
                <option value="vote">Vote (Day)</option>
              </select>
            </div>
          </div>

          <div class="btnRow">
            <button id="doActionBtn" class="btn" type="button">Submit</button>
          </div>

          <div class="hr"></div>

          <!-- Host Controls -->
          <div id="hostControls" style="display:none;">
            <div class="title">Host Controls</div>
            <div class="btnRow">
              <button id="startMafiaBtn" class="btn" type="button">Start Mafia</button>
              <button id="nextBtn" class="btn secondary" type="button">Next Phase</button>
              <button id="forceNightBtn" class="btn secondary small" type="button">Force Resolve Night</button>
              <button id="forceDayBtn" class="btn secondary small" type="button">Force Resolve Day</button>
            </div>

            <!-- Dev Panel -->
            <div id="devPanel" style="display:none;margin-top:14px;">
              <div class="title">Dev Tools (Test)</div>
              <div class="small">
                Dev mode starts from <b>2 players</b> and allows role controls.
              </div>

              <div class="btnRow" style="margin-top:10px;">
                <button id="revealBtn" class="btn secondary" type="button">Reveal Roles</button>
              </div>

              <div class="row2" style="margin-top:10px;">
                <div>
                  <div class="small">Pick Player</div>
                  <select id="devPlayerSelect" class="select"></select>
                </div>
                <div>
                  <div class="small">Set Role</div>
                  <select id="devRoleSelect" class="select">
                    <option value="mafia">mafia</option>
                    <option value="detective">detective</option>
                    <option value="doctor">doctor</option>
                    <option value="villager">villager</option>
                  </select>
                </div>
              </div>

              <div class="btnRow">
                <button id="setRoleBtn" class="btn secondary" type="button">Apply Role</button>
                <button id="toggleAliveBtn" class="btn secondary" type="button">Toggle Alive/Dead</button>
              </div>

              <div class="box" style="margin-top:10px;">
                <div class="small">Revealed Roles (Host only)</div>
                <div id="revealList" class="small mono" style="margin-top:8px;">&mdash;</div>
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="title">Last Result</div>
          <div id="lastResult" class="small">&mdash;</div>
        </div>

        <!-- ===== SCOREBOARD TAB ===== -->
        <div id="tab-score" class="box" style="display:none;">
          <div class="title">Scoreboard</div>
          <div id="scoreList"></div>
        </div>

      </div><!-- /grid -->
    </div><!-- /card -->
  </div><!-- /wrap -->

  <div id="toast" class="toast">OK</div>

  <script src="https://jackbox-server-pwtr.onrender.com/socket.io/socket.io.js"></script>
  <script src="/common.js"></script>
  <script>
    const qs = new URLSearchParams(location.search);
    const roomCode = (qs.get("room") || "").trim().toUpperCase();
    const dev = qs.get("dev") === "1";

    const socket = createSocket();

    /* ---- DOM refs ---- */
    const light        = document.getElementById("light");
    const roomCodeEl   = document.getElementById("roomCode");
    const devBadge     = document.getElementById("devBadge");
    const pCount       = document.getElementById("pCount");
    const meName       = document.getElementById("meName");

    const playersList  = document.getElementById("playersList");
    const readyBtn     = document.getElementById("readyBtn");
    const leaveBtn     = document.getElementById("leaveBtn");

    const phaseEl      = document.getElementById("phase");
    const roundEl      = document.getElementById("round");
    const winnerEl     = document.getElementById("winner");
    const myRoleEl     = document.getElementById("myRole");
    const lastResultEl = document.getElementById("lastResult");
    const investigationBox = document.getElementById("investigationBox");

    const targetSelect = document.getElementById("targetSelect");
    const actionSelect = document.getElementById("actionSelect");
    const doActionBtn  = document.getElementById("doActionBtn");

    const hostControls   = document.getElementById("hostControls");
    const startMafiaBtn  = document.getElementById("startMafiaBtn");
    const nextBtn        = document.getElementById("nextBtn");
    const forceNightBtn  = document.getElementById("forceNightBtn");
    const forceDayBtn    = document.getElementById("forceDayBtn");

    const devPanel        = document.getElementById("devPanel");
    const revealBtn       = document.getElementById("revealBtn");
    const revealList      = document.getElementById("revealList");
    const devPlayerSelect = document.getElementById("devPlayerSelect");
    const devRoleSelect   = document.getElementById("devRoleSelect");
    const setRoleBtn      = document.getElementById("setRoleBtn");
    const toggleAliveBtn  = document.getElementById("toggleAliveBtn");

    const scoreList = document.getElementById("scoreList");

    roomCodeEl.textContent = roomCode || "----";
    if (dev) devBadge.classList.add("on");

    /* ---- State ---- */
    let isHost = false;
    let myReady = false;
    let currentPlayers = [];
    let mafiaState = null;

    /* ---- Status & Reconnection ---- */
    bindStatusLight(socket, light);
    setupReconnectOverlay(socket);

    /* ---- Tabs ---- */
    document.querySelectorAll(".tab").forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll(".tab").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        const key = btn.dataset.tab;
        ["players","games","mafia","score"].forEach(k => {
          const el = document.getElementById("tab-" + k);
          if (el) el.style.display = (k === key) ? "block" : "none";
        });
      };
    });

    /* ---- Render: Players ---- */
    function renderPlayers(players){
      playersList.innerHTML = "";
      currentPlayers = players || [];
      pCount.textContent = String(currentPlayers.length);

      const me = currentPlayers.find(p => p.clientId === clientId);
      meName.textContent = me ? me.name : "\u2014";
      myReady = !!(me && me.ready);
      readyBtn.textContent = myReady ? "Unready" : "Ready";

      // Refresh target dropdowns
      targetSelect.innerHTML = "";
      devPlayerSelect.innerHTML = "";

      const addOpt = (sel, p) => {
        const opt = document.createElement("option");
        opt.value = p.clientId;
        opt.textContent = p.name + (p.clientId === clientId ? " (you)" : "");
        sel.appendChild(opt);
      };

      currentPlayers.forEach(p => addOpt(devPlayerSelect, p));

      // For action targets: alive only if mafia state exists
      const candidates = (mafiaState && mafiaState.alive)
        ? mafiaState.alive.filter(a => a.alive)
        : currentPlayers;
      candidates.forEach(p => addOpt(targetSelect, p));

      // Render player cards
      currentPlayers.forEach(p => {
        const div = document.createElement("div");
        div.className = "player";
        div.innerHTML = `
          <div style="font-weight:950; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            ${escapeHtml(p.name)}${p.clientId === clientId ? " (You)" : ""}
          </div>
          <div class="badge ${p.ready ? "ready" : ""}">${p.ready ? "READY" : "WAIT"}</div>
        `;
        playersList.appendChild(div);
      });

      if (!currentPlayers.length) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "No players yet";
        playersList.appendChild(div);
      }
    }

    /* ---- Render: Last Result ---- */
    function renderLastResult(s){
      if (!s || !s.lastResult){ lastResultEl.textContent = "\u2014"; return; }
      const r = s.lastResult;
      if (r.type === "night") {
        const died = r.died ? r.died.name : "No one";
        lastResultEl.textContent = "Night: " + died + " died.";
        return;
      }
      if (r.type === "day") {
        if (r.tie) lastResultEl.textContent = "Day: Tie \u2014 no one eliminated.";
        else {
          const el = r.eliminated ? r.eliminated.name : "No one";
          lastResultEl.textContent = "Day: " + el + " eliminated.";
        }
        return;
      }
      lastResultEl.textContent = "\u2014";
    }

    /* ---- Render: Scoreboard ---- */
    function renderScoreboard(state){
      scoreList.innerHTML = "";
      const list = (state && state.leaderboard) ? state.leaderboard : [];
      if (!list.length) {
        const div = document.createElement("div");
        div.className = "small";
        div.textContent = "No scores yet";
        scoreList.appendChild(div);
        return;
      }
      list.forEach((x, idx) => {
        const div = document.createElement("div");
        div.className = "player";
        div.innerHTML = `
          <div>
            <div style="font-weight:1000;">#${idx+1} ${escapeHtml(x.name || "Player")}</div>
            <div class="small">wins: ${x.wins || 0} &bull; played: ${x.gamesPlayed || 0}</div>
          </div>
          <div class="badge ready">${x.points || 0} pts</div>
        `;
        scoreList.appendChild(div);
      });
    }

    /* ---- Phase animation helper ---- */
    let lastPhase = null;
    function animatePhaseChange(newPhase){
      if (lastPhase !== newPhase && newPhase) {
        phaseEl.classList.remove("phase-enter");
        void phaseEl.offsetWidth; // reflow
        phaseEl.classList.add("phase-enter");
      }
      lastPhase = newPhase;
    }

    /* ---- Socket: Connect ---- */
    socket.on("connect", () => {
      if (!roomCode) return;
      socket.emit("host:attach", { roomCode });
      socket.emit("room:getState", { roomCode });
      socket.emit("hub:getState", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId });
    });

    socket.on("disconnect", () => {
      // overlay handles visual, nothing else needed
    });

    socket.on("host:attached", () => {
      // confirmed as host
    });

    socket.on("host:attach:error", () => {
      socket.emit("player:attach", { roomCode, clientId });
    });

    /* ---- Socket: Room State ---- */
    socket.on("room:state", (st) => {
      if (!st) return;
      isHost = (st.hostClientId && st.hostClientId === clientId);
      hostControls.style.display = isHost ? "block" : "none";

      if (dev && isHost) {
        devPanel.style.display = "block";
        socket.emit("host:setDevMode", { roomCode, enabled: true });
      } else {
        devPanel.style.display = "none";
      }

      renderPlayers(st.players || []);
    });

    /* ---- Socket: Hub State ---- */
    socket.on("hub:state", (st) => {
      renderScoreboard(st);
      if (st && st.devMode) devBadge.classList.add("on");
    });

    /* ---- Socket: Mafia events ---- */
    socket.on("start:error", ({ message, minPlayers } = {}) => {
      if (message === "NEED_MIN_PLAYERS") {
        showToast("Need " + minPlayers + " players");
      } else {
        showToast(message || "Start error");
      }
    });

    socket.on("mafia:role", ({ role } = {}) => {
      myRoleEl.textContent = role ? String(role).toUpperCase() : "\u2014";
    });

    socket.on("mafia:state", (s) => {
      if (!s) return;
      mafiaState = s;

      animatePhaseChange(s.phase);
      phaseEl.textContent = labelPhase(s.phase);
      roundEl.textContent = s.round || "\u2014";
      winnerEl.textContent = s.winnerTeam ? s.winnerTeam.toUpperCase() : "\u2014";
      myRoleEl.textContent = s.myRole ? String(s.myRole).toUpperCase() : (myRoleEl.textContent || "\u2014");

      if (s.investigationResult) {
        investigationBox.style.display = "block";
        const tgt = s.investigationResult.targetId;
        const isMafia = !!s.investigationResult.isMafia;
        const tgtName = (currentPlayers.find(p => p.clientId === tgt) || {}).name || "Player";
        investigationBox.textContent = "Detective: " + tgtName + " is " + (isMafia ? "MAFIA" : "NOT mafia") + ".";
      } else {
        investigationBox.style.display = "none";
      }

      renderPlayers(currentPlayers);
      renderLastResult(s);
    });

    socket.on("mafia:reveal", ({ list } = {}) => {
      if (!list || !list.length) { revealList.textContent = "\u2014"; return; }
      revealList.textContent = list.map(x =>
        x.name + " = " + x.role + (x.alive ? "" : " (dead)")
      ).join("\n");
      showToast("Roles revealed");
    });

    socket.on("mafia:tick", () => {
      socket.emit("mafia:getState", { roomCode, clientId });
    });

    /* ---- Socket: Navigation events ---- */
    socket.on("room:closed", () => {
      showToast("Room closed");
      setTimeout(() => location.href = WEB_ORIGIN + "/", 600);
    });

    /* ---- Button Handlers ---- */
    readyBtn.onclick = () => {
      if (!roomCode) return;
      myReady = !myReady;
      socket.emit("player:ready", { roomCode, ready: myReady, clientId });
    };

    leaveBtn.onclick = () => {
      if (!roomCode) return;
      socket.emit("player:leave", { roomCode, clientId });
      showToast("Left");
      setTimeout(() => location.href = "/", 300);
    };

    /* Game selection */
    document.getElementById("gameMafiaCard").onclick = () => {
      if (!isHost) { showToast("Host only"); return; }
      socket.emit("hub:setGame", { roomCode, game: "mafia" });
      showToast("Mafia selected");
      // Switch to mafia tab
      document.querySelector('[data-tab="mafia"]').click();
    };

    /* Mafia controls */
    startMafiaBtn.onclick = () => socket.emit("mafia:start", { roomCode });
    nextBtn.onclick       = () => socket.emit("mafia:next", { roomCode });
    forceNightBtn.onclick = () => socket.emit("mafia:forceResolveNight", { roomCode });
    forceDayBtn.onclick   = () => socket.emit("mafia:forceResolveDay", { roomCode });

    doActionBtn.onclick = () => {
      const tgt = targetSelect.value;
      const act = actionSelect.value;
      if (!tgt) return showToast("Pick target");

      if (act === "vote") {
        socket.emit("mafia:vote", { roomCode, clientId, targetId: tgt });
        showToast("Voted");
        return;
      }
      socket.emit("mafia:nightAction", { roomCode, clientId, action: act, targetId: tgt });
      showToast("Sent");
    };

    /* Dev tools */
    revealBtn.onclick = () => socket.emit("mafia:revealAll", { roomCode });

    setRoleBtn.onclick = () => {
      const p = devPlayerSelect.value;
      const r = devRoleSelect.value;
      if (!p) return;
      socket.emit("mafia:setRole", { roomCode, targetId: p, role: r });
      showToast("Role applied");
    };

    toggleAliveBtn.onclick = () => {
      const p = devPlayerSelect.value;
      if (!p) return;
      socket.emit("mafia:toggleAlive", { roomCode, targetId: p });
      showToast("Toggled");
    };

    /* ---- Polling (fallback, 5s) ---- */
    setInterval(() => {
      if (!roomCode || !socket.connected) return;
      socket.emit("room:getState", { roomCode });
      socket.emit("hub:getState", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId });
    }, 5000);
  </script>
</body>
</html>
