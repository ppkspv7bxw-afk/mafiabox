<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lobby</title>
  <style>
    :root{--bg:#0b1020;--text:#eef1ff;--muted:#a7b0d6;--border:rgba(255,255,255,.10);--shadow:0 14px 40px rgba(0,0,0,.45);--red:#ff2e55;--green:#2ee59d;--btn1:#ff3b6a;--btn2:#ff1f4f;--radius:18px;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(1100px 760px at 70% 0%,#1a2350 0%,var(--bg) 55%);color:var(--text)}
    .wrap{max-width:900px;margin:0 auto;padding:22px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));border:1px solid var(--border);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow);position:relative}
    .statusLight{position:absolute;top:14px;left:14px;width:14px;height:14px;border-radius:999px;background:var(--red);box-shadow:0 0 0 4px rgba(255,46,85,.12),0 0 18px rgba(255,46,85,.35)}
    .statusLight.ok{background:var(--green);box-shadow:0 0 0 4px rgba(46,229,157,.14),0 0 18px rgba(46,229,157,.35)}
    .brand{display:flex;justify-content:center;margin-top:6px;margin-bottom:12px}
    .brand img{width:300px;max-width:88%;height:auto;filter:drop-shadow(0 18px 34px rgba(255,35,79,.18));border-radius:18px;border:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.25)}
    .roomCodeBig{margin-top:10px;font-size:64px;font-weight:950;letter-spacing:10px;padding:14px 18px;border-radius:16px;background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.10);text-align:center;user-select:none}
    .hint{margin-top:10px;padding:12px;border-radius:16px;border:1px dashed rgba(255,255,255,.18);color:rgba(167,176,214,.90);background:rgba(255,255,255,.03);text-align:center;font-weight:900}
    .grid{margin-top:14px;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .player{padding:12px;border-radius:16px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);display:flex;justify-content:space-between;align-items:center;gap:10px}
    .player .name{font-weight:950;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .badge{font-weight:950;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.06);color:rgba(167,176,214,.95)}
    .badge.ready{border-color:rgba(46,229,157,.25);color:rgba(46,229,157,.95);background:rgba(46,229,157,.10)}
    .row{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center}
    .btn{border:0;border-radius:16px;padding:14px 18px;font-weight:950;cursor:pointer;color:#fff;background:linear-gradient(135deg,var(--btn1),var(--btn2));box-shadow:0 12px 26px rgba(255,35,79,.22)}
    .btn.secondary{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);box-shadow:none;color:var(--text)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <span id="light" class="statusLight"></span>
      <div class="brand"><img src="/brand.png" alt="brand"></div>
      <div id="roomBig" class="roomCodeBig">— — — —</div>
      <div class="hint">اختر اللعبة ثم Start</div>

      <div id="players" class="grid"></div>

      <div class="row">
        <button class="btn" id="startMafia">Start Mafia</button>
        <button class="btn secondary" id="back">رجوع</button>
      </div>
    </div>
  </div>

  <script src="https://jackbox-server-pwtr.onrender.com/socket.io/socket.io.js"></script>
  <script>
    const SERVER_URL = "https://jackbox-server-pwtr.onrender.com";

    const clientId = localStorage.getItem("clientId") || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random());
    localStorage.setItem("clientId", clientId);

    const socket = io(SERVER_URL, { transports:["websocket","polling"], auth:{ clientId } });

    const light = document.getElementById("light");
    const roomBigEl = document.getElementById("roomBig");
    const playersEl = document.getElementById("players");
    const backBtn = document.getElementById("back");
    const startMafiaBtn = document.getElementById("startMafia");

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, (c) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }
    function normalizeRoom(text){
      return String(text || "").trim().toUpperCase().replace(/[^A-Z0-9]/g, "").slice(0, 8);
    }

    const params = new URLSearchParams(location.search);
    const roomCode = normalizeRoom(params.get("room") || "");
    roomBigEl.textContent = roomCode || "— — — —";

    socket.on("connect", () => {
      light.classList.add("ok");
      if (roomCode) socket.emit("player:attach", { roomCode, clientId });
    });
    socket.on("disconnect", () => light.classList.remove("ok"));

    socket.on("room:state", ({ roomCode: code, players }) => {
      if (roomCode && code !== roomCode) return;
      playersEl.innerHTML = "";
      (players || []).forEach(p => {
        const div = document.createElement("div");
        div.className = "player";
        const ready = !!p.ready;
        div.innerHTML = `
          <div class="name">${escapeHtml(p.name || "")}</div>
          <div class="badge ${ready ? "ready" : ""}">${ready ? "READY" : "WAIT"}</div>
        `;
        playersEl.appendChild(div);
      });
    });

    startMafiaBtn.onclick = () => {
      if (!roomCode) return;
      socket.emit("host:launchGame", { roomCode, gameKey: "mafia" });
    };

    socket.on("game:launch", ({ roomCode: code, gameKey }) => {
      if (roomCode && code !== roomCode) return;
      if (gameKey === "mafia") window.location.href = `/mafia.html?room=${encodeURIComponent(roomCode)}`;
    });

    backBtn.onclick = () => window.location.href = "/";
  </script>
</body>
</html>
