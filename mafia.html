<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Mafia â€” GameHub4u</title>
  <link rel="stylesheet" href="/common.css"/>
</head>
<body>
  <div class="wrap wrap--wide">
    <div class="card">
      <span id="light" class="statusLight"></span>
      <div class="brand"><img src="/brand.png" alt="brand"></div>

      <div class="row">
        <div class="pill">Room: <span id="roomCode" class="roomCode">----</span></div>
        <div class="pill">Round: <strong id="round">1</strong></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
          <button id="nextBtn" class="btn secondary" type="button" disabled>Next</button>
          <button id="backBtn" class="btn secondary" type="button" disabled>Back to Lobby</button>
        </div>
      </div>

      <div class="hero">
        <div class="roleBox">
          <div>
            <div class="small">Your role</div>
            <div id="role" class="roleName">&mdash;</div>
            <div class="small" id="investigation"></div>
          </div>
          <div>
            <div class="small">Phase</div>
            <div id="phase" class="phase">&mdash;</div>
          </div>
        </div>

        <div id="result" class="small" style="margin-top:10px;"></div>
        <div id="winner" style="margin-top:8px;font-weight:1000;"></div>

        <div id="hostBox" class="hostBox">
          <div style="font-weight:1000;">Host Console</div>
          <div class="kpi" style="margin-top:8px;">
            <div class="pill">Alive: <strong id="kAlive">0</strong></div>
            <div class="pill">Votes: <strong id="kVotes">0</strong></div>
            <div class="pill">Mafia picked: <strong id="kMafia">&mdash;</strong></div>
            <div class="pill">Doctor picked: <strong id="kDoc">&mdash;</strong></div>
            <div class="pill">Detective picked: <strong id="kDet">&mdash;</strong></div>
          </div>
          <div class="hostRow">
            <button id="resolveNightBtn" class="btn secondary" type="button" disabled>Resolve Night Now</button>
            <button id="resolveDayBtn" class="btn secondary" type="button" disabled>Resolve Day Now</button>
          </div>
          <div class="small" style="margin-top:8px;">Force-resolve if someone is AFK.</div>
        </div>
      </div>

      <div class="panel">
        <h3>Action</h3>
        <div id="actionHint" class="small">Waiting&hellip;</div>
      </div>

      <div id="players" class="grid"></div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <script src="https://jackbox-server-pwtr.onrender.com/socket.io/socket.io.js"></script>
  <script src="/common.js"></script>
  <script>
    let roomCode = (getParam("room") || "").trim().toUpperCase();

    const light            = document.getElementById("light");
    const roomCodeEl       = document.getElementById("roomCode");
    const roundEl          = document.getElementById("round");
    const roleEl           = document.getElementById("role");
    const phaseEl          = document.getElementById("phase");
    const playersEl        = document.getElementById("players");
    const actionHint       = document.getElementById("actionHint");
    const investigationEl  = document.getElementById("investigation");
    const resultEl         = document.getElementById("result");
    const winnerEl         = document.getElementById("winner");
    const nextBtn          = document.getElementById("nextBtn");
    const backBtn          = document.getElementById("backBtn");
    const hostBox          = document.getElementById("hostBox");
    const kAlive           = document.getElementById("kAlive");
    const kVotes           = document.getElementById("kVotes");
    const kMafia           = document.getElementById("kMafia");
    const kDoc             = document.getElementById("kDoc");
    const kDet             = document.getElementById("kDet");
    const resolveNightBtn  = document.getElementById("resolveNightBtn");
    const resolveDayBtn    = document.getElementById("resolveDayBtn");

    const socket = createSocket();
    bindStatusLight(socket, light);
    setupReconnectOverlay(socket);

    let state = null;
    let lastPhaseVal = null;

    function amIDead(){
      const me = state && state.alive ? state.alive.find(x => x.clientId === clientId) : null;
      return me ? !me.alive : false;
    }

    function onPickTarget(targetId){
      if (!state || !state.myRole) return;
      if (amIDead()) { showToast("You are dead"); return; }

      if (state.phase === "night"){
        if (state.myRole === "mafia"){
          socket.emit("mafia:nightAction", { roomCode, clientId, action: "kill", targetId });
          showToast("Kill selected");
        } else if (state.myRole === "doctor"){
          socket.emit("mafia:nightAction", { roomCode, clientId, action: "save", targetId });
          showToast("Save selected");
        } else if (state.myRole === "detective"){
          socket.emit("mafia:nightAction", { roomCode, clientId, action: "check", targetId });
          showToast("Investigate selected");
        } else {
          showToast("No night action");
        }
      } else if (state.phase === "day"){
        socket.emit("mafia:vote", { roomCode, clientId, targetId });
        showToast("Vote cast");
      }
    }

    function renderPlayers(list){
      playersEl.innerHTML = "";
      (list||[]).forEach(p => {
        const div = document.createElement("div");
        div.className = "player" + (p.alive && state && state.winnerTeam === null ? " clickable" : "");
        div.dataset.id = p.clientId;
        div.innerHTML = `
          <div class="name">${escapeHtml(p.name||"Player")}${p.clientId===clientId ? " (You)" : ""}</div>
          <div class="badge ${p.alive ? "" : "dead"}">${p.alive ? "ALIVE" : "DEAD"}</div>
        `;
        if (p.alive && state && state.winnerTeam === null){
          div.onclick = () => onPickTarget(p.clientId);
        }
        playersEl.appendChild(div);
      });
    }

    function renderHostStats(){
      const hs = state && state.hostStats;
      const isHost = !!(state && state.canAdvance);

      hostBox.style.display = isHost ? "block" : "none";
      if (!isHost || !hs) return;

      kAlive.textContent = hs.aliveCount;
      kVotes.textContent = hs.votedCount;
      kMafia.textContent = hs.mafiaPicked ? "YES" : "NO";
      kDoc.textContent = hs.doctorPicked ? "YES" : "NO";
      kDet.textContent = hs.detectivePicked ? "YES" : "NO";

      resolveNightBtn.disabled = state.winnerTeam || state.phase !== "night";
      resolveDayBtn.disabled = state.winnerTeam || state.phase !== "day";
    }

    function renderState(s){
      state = s;
      if (!state) return;

      roomCodeEl.textContent = roomCode || "----";
      roundEl.textContent = state.round || 1;
      roleEl.textContent = labelRole(state.myRole);

      /* Phase animation */
      if (lastPhaseVal !== state.phase && state.phase) {
        phaseEl.classList.remove("phase-enter");
        void phaseEl.offsetWidth;
        phaseEl.classList.add("phase-enter");
      }
      lastPhaseVal = state.phase;
      phaseEl.textContent = labelPhase(state.phase);

      nextBtn.disabled = !state.canAdvance || !!state.winnerTeam;
      backBtn.disabled = !state.winnerTeam;

      if (state.investigationResult && state.myRole === "detective"){
        const t = state.investigationResult.targetId;
        const isM = state.investigationResult.isMafia;
        const nm = (state.alive.find(x => x.clientId === t) || {}).name || "Player";
        investigationEl.textContent = "Investigation: " + nm + " is " + (isM ? "MAFIA" : "NOT MAFIA");
      } else {
        investigationEl.textContent = "";
      }

      if (state.lastResult){
        if (state.lastResult.type === "night"){
          const died = state.lastResult.died ? state.lastResult.died.name : "No one";
          resultEl.textContent = "Night result: " + died + " died.";
        } else if (state.lastResult.type === "day"){
          if (state.lastResult.tie){
            resultEl.textContent = "Day result: Tie vote \u2014 no one eliminated.";
          } else {
            const el = state.lastResult.eliminated ? state.lastResult.eliminated.name : "No one";
            resultEl.textContent = "Day result: " + el + " eliminated.";
          }
        }
      } else {
        resultEl.textContent = "";
      }

      if (state.winnerTeam){
        winnerEl.textContent = state.winnerTeam === "mafia" ? "MAFIA WINS (+10)" : "TOWN WINS (+10)";
        backBtn.disabled = false;
      } else {
        winnerEl.textContent = "";
      }

      if (state.winnerTeam){
        actionHint.textContent = "Game over. Back to lobby.";
      } else if (state.phase === "role"){
        actionHint.textContent = "Host: press Next to start the Night.";
      } else if (state.phase === "night"){
        if (amIDead()) actionHint.textContent = "You are dead \u2014 wait.";
        else if (state.myRole === "mafia") actionHint.textContent = "Pick someone to KILL (click a player).";
        else if (state.myRole === "doctor") actionHint.textContent = "Pick someone to SAVE (click a player).";
        else if (state.myRole === "detective") actionHint.textContent = "Pick someone to INVESTIGATE (click a player).";
        else actionHint.textContent = "Wait for the night to end.";
      } else if (state.phase === "day"){
        if (amIDead()) actionHint.textContent = "You are dead \u2014 wait.";
        else actionHint.textContent = "Vote: click a player to eliminate.";
      } else {
        actionHint.textContent = "Waiting\u2026";
      }

      renderPlayers(state.alive || []);
      renderHostStats();
    }

    /* ---- Socket events ---- */
    socket.on("connect", () => {
      if (!roomCode){ showToast("Missing room"); return; }
      socket.emit("player:attach", { roomCode, clientId });
      socket.emit("host:attach", { roomCode });
      socket.emit("mafia:getState", { roomCode, clientId });
    });

    socket.on("disconnect", () => {
      nextBtn.disabled = true;
      backBtn.disabled = true;
      resolveNightBtn.disabled = true;
      resolveDayBtn.disabled = true;
    });

    socket.on("mafia:role", ({ role } = {}) => {
      if (role) roleEl.textContent = labelRole(role);
    });

    socket.on("mafia:state", (s) => renderState(s));
    socket.on("mafia:tick", () => socket.emit("mafia:getState", { roomCode, clientId }));

    nextBtn.onclick = () => socket.emit("mafia:next", { roomCode });
    backBtn.onclick = () => socket.emit("mafia:backToLobby", { roomCode });

    resolveNightBtn.onclick = () => socket.emit("mafia:forceResolveNight", { roomCode });
    resolveDayBtn.onclick   = () => socket.emit("mafia:forceResolveDay", { roomCode });

    socket.on("hub:lobby", ({ roomCode: rc } = {}) => {
      const code = (rc || roomCode || "").trim().toUpperCase();
      location.href = WEB_ORIGIN + "/lobby.html?room=" + encodeURIComponent(code);
    });

    socket.on("room:closed", () => {
      showToast("Room closed");
      setTimeout(() => location.href = WEB_ORIGIN + "/", 600);
    });
  </script>
</body>
</html>
